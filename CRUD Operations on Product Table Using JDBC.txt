import java.sql.*;
import java.util.Scanner;

public class ProductCRUD {
    // Database credentials
    private static final String URL = "jdbc:mysql://localhost:3306/productdb";
    private static final String USER = "root";
    private static final String PASSWORD = "password";
    
    private Connection connection;
    private Scanner scanner;
    
    public ProductCRUD() {
        scanner = new Scanner(System.in);
        connectToDatabase();
    }
    
    // Establish database connection
    private void connectToDatabase() {
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
            connection = DriverManager.getConnection(URL, USER, PASSWORD);
            System.out.println("Database connected successfully!");
            createTableIfNotExists();
        } catch (ClassNotFoundException e) {
            System.err.println("MySQL JDBC Driver not found!");
            e.printStackTrace();
        } catch (SQLException e) {
            System.err.println("Connection failed!");
            e.printStackTrace();
        }
    }
    
    // Create Product table if it doesn't exist
    private void createTableIfNotExists() {
        String createTableSQL = "CREATE TABLE IF NOT EXISTS Product (" +
                "ProductID INT PRIMARY KEY AUTO_INCREMENT, " +
                "ProductName VARCHAR(100) NOT NULL, " +
                "Price DECIMAL(10, 2) NOT NULL, " +
                "Quantity INT NOT NULL)";
        
        try (Statement stmt = connection.createStatement()) {
            stmt.execute(createTableSQL);
            System.out.println("Product table ready!");
        } catch (SQLException e) {
            System.err.println("Error creating table!");
            e.printStackTrace();
        }
    }
    
    // CREATE: Insert a new product
    private void createProduct() {
        System.out.println("\n=== CREATE NEW PRODUCT ===");
        
        try {
            System.out.print("Enter Product Name: ");
            String name = scanner.nextLine();
            
            System.out.print("Enter Price: ");
            double price = Double.parseDouble(scanner.nextLine());
            
            System.out.print("Enter Quantity: ");
            int quantity = Integer.parseInt(scanner.nextLine());
            
            String insertSQL = "INSERT INTO Product (ProductName, Price, Quantity) VALUES (?, ?, ?)";
            
            connection.setAutoCommit(false); // Start transaction
            
            try (PreparedStatement pstmt = connection.prepareStatement(insertSQL)) {
                pstmt.setString(1, name);
                pstmt.setDouble(2, price);
                pstmt.setInt(3, quantity);
                
                int rowsAffected = pstmt.executeUpdate();
                
                connection.commit(); // Commit transaction
                System.out.println("\n✓ Product created successfully! Rows affected: " + rowsAffected);
                
            } catch (SQLException e) {
                connection.rollback(); // Rollback on error
                System.err.println("✗ Error creating product! Transaction rolled back.");
                e.printStackTrace();
            } finally {
                connection.setAutoCommit(true); // Reset auto-commit
            }
            
        } catch (NumberFormatException e) {
            System.err.println("✗ Invalid input format!");
        } catch (SQLException e) {
            System.err.println("✗ Database error!");
            e.printStackTrace();
        }
    }
    
    // READ: Display all products
    private void readProducts() {
        System.out.println("\n=== ALL PRODUCTS ===");
        
        String selectSQL = "SELECT * FROM Product ORDER BY ProductID";
        
        try (Statement stmt = connection.createStatement();
             ResultSet rs = stmt.executeQuery(selectSQL)) {
            
            System.out.println("-------------------------------------------------------------------------");
            System.out.printf("%-12s %-30s %-15s %-10s%n", 
                            "ProductID", "ProductName", "Price", "Quantity");
            System.out.println("-------------------------------------------------------------------------");
            
            boolean hasRecords = false;
            while (rs.next()) {
                hasRecords = true;
                int id = rs.getInt("ProductID");
                String name = rs.getString("ProductName");
                double price = rs.getDouble("Price");
                int quantity = rs.getInt("Quantity");
                
                System.out.printf("%-12d %-30s $%-14.2f %-10d%n", 
                                id, name, price, quantity);
            }
            System.out.println("-------------------------------------------------------------------------");
            
            if (!hasRecords) {
                System.out.println("No products found in the database.");
            }
            
        } catch (SQLException e) {
            System.err.println("✗ Error reading products!");
            e.printStackTrace();
        }
    }
    
    // UPDATE: Modify product details
    private void updateProduct() {
        System.out.println("\n=== UPDATE PRODUCT ===");
        
        try {
            System.out.print("Enter Product ID to update: ");
            int productId = Integer.parseInt(scanner.nextLine());
            
            // Check if product exists
            if (!productExists(productId)) {
                System.out.println("✗ Product with ID " + productId + " not found!");
                return;
            }
            
            System.out.print("Enter new Product Name (or press Enter to skip): ");
            String name = scanner.nextLine();
            
            System.out.print("Enter new Price (or press Enter to skip): ");
            String priceInput = scanner.nextLine();
            
            System.out.print("Enter new Quantity (or press Enter to skip): ");
            String quantityInput = scanner.nextLine();
            
            // Build dynamic update query
            StringBuilder updateSQL = new StringBuilder("UPDATE Product SET ");
            boolean hasUpdate = false;
            
            if (!name.isEmpty()) {
                updateSQL.append("ProductName = ?");
                hasUpdate = true;
            }
            
            if (!priceInput.isEmpty()) {
                if (hasUpdate) updateSQL.append(", ");
                updateSQL.append("Price = ?");
                hasUpdate = true;
            }
            
            if (!quantityInput.isEmpty()) {
                if (hasUpdate) updateSQL.append(", ");
                updateSQL.append("Quantity = ?");
                hasUpdate = true;
            }
            
            if (!hasUpdate) {
                System.out.println("✗ No fields to update!");
                return;
            }
            
            updateSQL.append(" WHERE ProductID = ?");
            
            connection.setAutoCommit(false); // Start transaction
            
            try (PreparedStatement pstmt = connection.prepareStatement(updateSQL.toString())) {
                int paramIndex = 1;
                
                if (!name.isEmpty()) {
                    pstmt.setString(paramIndex++, name);
                }
                if (!priceInput.isEmpty()) {
                    pstmt.setDouble(paramIndex++, Double.parseDouble(priceInput));
                }
                if (!quantityInput.isEmpty()) {
                    pstmt.setInt(paramIndex++, Integer.parseInt(quantityInput));
                }
                pstmt.setInt(paramIndex, productId);
                
                int rowsAffected = pstmt.executeUpdate();
                
                connection.commit(); // Commit transaction
                System.out.println("\n✓ Product updated successfully! Rows affected: " + rowsAffected);
                
            } catch (SQLException e) {
                connection.rollback(); // Rollback on error
                System.err.println("✗ Error updating product! Transaction rolled back.");
                e.printStackTrace();
            } finally {
                connection.setAutoCommit(true); // Reset auto-commit
            }
            
        } catch (NumberFormatException e) {
            System.err.println("✗ Invalid input format!");
        } catch (SQLException e) {
            System.err.println("✗ Database error!");
            e.printStackTrace();
        }
    }
    
    // DELETE: Remove a product
    private void deleteProduct() {
        System.out.println("\n=== DELETE PRODUCT ===");
        
        try {
            System.out.print("Enter Product ID to delete: ");
            int productId = Integer.parseInt(scanner.nextLine());
            
            // Check if product exists
            if (!productExists(productId)) {
                System.out.println("✗ Product with ID " + productId + " not found!");
                return;
            }
            
            System.out.print("Are you sure you want to delete this product? (yes/no): ");
            String confirmation = scanner.nextLine();
            
            if (!confirmation.equalsIgnoreCase("yes")) {
                System.out.println("Delete operation cancelled.");
                return;
            }
            
            String deleteSQL = "DELETE FROM Product WHERE ProductID = ?";
            
            connection.setAutoCommit(false); // Start transaction
            
            try (PreparedStatement pstmt = connection.prepareStatement(deleteSQL)) {
                pstmt.setInt(1, productId);
                
                int rowsAffected = pstmt.executeUpdate();
                
                connection.commit(); // Commit transaction
                System.out.println("\n✓ Product deleted successfully! Rows affected: " + rowsAffected);
                
            } catch (SQLException e) {
                connection.rollback(); // Rollback on error
                System.err.println("✗ Error deleting product! Transaction rolled back.");
                e.printStackTrace();
            } finally {
                connection.setAutoCommit(true); // Reset auto-commit
            }
            
        } catch (NumberFormatException e) {
            System.err.println("✗ Invalid input format!");
        } catch (SQLException e) {
            System.err.println("✗ Database error!");
            e.printStackTrace();
        }
    }
    
    // Helper method to check if product exists
    private boolean productExists(int productId) throws SQLException {
        String checkSQL = "SELECT COUNT(*) FROM Product WHERE ProductID = ?";
        try (PreparedStatement pstmt = connection.prepareStatement(checkSQL)) {
            pstmt.setInt(1, productId);
            ResultSet rs = pstmt.executeQuery();
            if (rs.next()) {
                return rs.getInt(1) > 0;
            }
        }
        return false;
    }
    
    // Display menu
    private void displayMenu() {
        System.out.println("\n╔════════════════════════════════════════╗");
        System.out.println("║     PRODUCT MANAGEMENT SYSTEM          ║");
        System.out.println("╠════════════════════════════════════════╣");
        System.out.println("║  1. Create Product                     ║");
        System.out.println("║  2. Read All Products                  ║");
        System.out.println("║  3. Update Product                     ║");
        System.out.println("║  4. Delete Product                     ║");
        System.out.println("║  5. Exit                               ║");
        System.out.println("╚════════════════════════════════════════╝");
        System.out.print("Enter your choice: ");
    }
    
    // Run the application
    public void run() {
        while (true) {
            displayMenu();
            
            try {
                int choice = Integer.parseInt(scanner.nextLine());
                
                switch (choice) {
                    case 1:
                        createProduct();
                        break;
                    case 2:
                        readProducts();
                        break;
                    case 3:
                        updateProduct();
                        break;
                    case 4:
                        deleteProduct();
                        break;
                    case 5:
                        closeConnection();
                        System.out.println("\nThank you for using Product Management System!");
                        return;
                    default:
                        System.out.println("✗ Invalid choice! Please select 1-5.");
                }
            } catch (NumberFormatException e) {
                System.out.println("✗ Invalid input! Please enter a number.");
            }
        }
    }
    
    // Close database connection
    private void closeConnection() {
        try {
            if (connection != null && !connection.isClosed()) {
                connection.close();
                System.out.println("Database connection closed.");
            }
            if (scanner != null) {
                scanner.close();
            }
        } catch (SQLException e) {
            System.err.println("Error closing connection!");
            e.printStackTrace();
        }
    }
    
    // Main method
    public static void main(String[] args) {
        ProductCRUD app = new ProductCRUD();
        app.run();
    }
}